{% extends 'base.html' %}
{% block title %}Liste D√Æmes{% endblock %}
{% block content %}
<h2 class="titre">Liste des D√Æmes</h2>

<!-- Barre de recherche -->
<input type="text" id="search" class="search-input" placeholder="üîç Rechercher un membre, un montant ou un re√ßu...">

<div class="flash-messages">
    {% with messages = get_flashed_messages() %}
        {% if messages %}
            {% for msg in messages %}
                <p style="color: {% if 'Erreur' in msg %}#F87171{% else %}#4ADE80{% endif %};">{{ msg }}</p>
            {% endfor %}
        {% endif %}
    {% endwith %}
</div>

<table class="dime-table sortable">
    <thead>
        <tr>
            <th>#</th>
            <th data-type="string"><i class="fas fa-user"></i> Membre</th>
            <th data-type="date"><i class="fas fa-calendar-alt"></i> Date</th>
            <th data-type="number"><i class="fas fa-coins"></i> Montant</th>
            <th data-type="string"><i class="fas fa-money-bill-wave"></i> Monnaie</th>
            <th><i class="fas fa-receipt"></i> Re√ßu</th>
        </tr>
    </thead>
    <tbody>
        {% for d in dimes %}
        <tr>
            <td>{{ loop.index }}</td>
            <td>{{ d.membre.nom }} {{ d.membre.postnom }}</td>
            <td>{{ d.date.strftime('%d/%m/%Y') }}</td>
            <td>{{ d.montant }}</td>
            <td>
                {% if d.monnaie == "USD" %}
                    <span class="badge usd">USD</span>
                {% else %}
                    <span class="badge fc">FC</span>
                {% endif %}
            </td>
            <td>
                <a href="{{ url_for('recu', dime_id=d.id) }}" class="recu-link">
                    <i class="fas fa-file-invoice-dollar"></i> {{ d.numero_recu }}
                </a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<style>
.titre {
    text-align: center;
    color: #4ADE80;
    margin-bottom: 15px;
}

/* Recherche */
.search-input {
    width: 100%;
    padding: 10px;
    margin: 12px 0;
    border-radius: 8px;
    border: none;
    background: #272727;
    color: #E0E0E0;
    font-size: 14px;
}
.search-input:focus {
    outline: 2px solid #4ADE80;
}

/* Tableau */
.dime-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
    background: #1E1E1E;
    border-radius: 10px;
    overflow: hidden;
    font-size: 14px;
}
.dime-table thead {
    background: #272727;
}
.dime-table th, .dime-table td {
    padding: 12px;
    text-align: left;
}
.dime-table th {
    color: #4ADE80;
    cursor: pointer;
    user-select: none;
}
.dime-table tbody tr:nth-child(even) {
    background: #2D2D2D;
}
.dime-table tbody tr:hover {
    background: #333333;
}

/* Badges Monnaie */
.badge {
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: bold;
    color: #fff;
}
.badge.usd { background: #16A34A; }  /* Vert fonc√© */
.badge.fc { background: #2563EB; }   /* Bleu */

/* Re√ßu */
.recu-link {
    color: #4ADE80;
    text-decoration: none;
    font-weight: bold;
}
.recu-link:hover {
    text-decoration: underline;
}

/* Tri visuel */
th.sorted-asc::after {
    content: " ‚ñ≤";
    color: #4ADE80;
}
th.sorted-desc::after {
    content: " ‚ñº";
    color: #4ADE80;
}
</style>

<script>
// Tri des colonnes
document.querySelectorAll("table.sortable thead th[data-type]").forEach(th => {
    th.addEventListener("click", function() {
        const table = th.closest("table");
        const tbody = table.querySelector("tbody");
        const rows = Array.from(tbody.querySelectorAll("tr"));
        const index = Array.from(th.parentNode.children).indexOf(th);
        const type = th.dataset.type;
        const isAsc = !th.classList.contains("sorted-asc");

        // Reset des classes de tri
        th.parentNode.querySelectorAll("th").forEach(h => h.classList.remove("sorted-asc", "sorted-desc"));
        th.classList.toggle("sorted-asc", isAsc);
        th.classList.toggle("sorted-desc", !isAsc);

        // Tri des lignes
        rows.sort((a, b) => {
            let A = a.children[index].innerText.trim().toLowerCase();
            let B = b.children[index].innerText.trim().toLowerCase();

            if (type === "number") {
                A = parseFloat(A.replace(/[^0-9.-]+/g, "")) || 0;
                B = parseFloat(B.replace(/[^0-9.-]+/g, "")) || 0;
            } else if (type === "date") {
                const [dayA, monthA, yearA] = A.split("/").map(Number);
                const [dayB, monthB, yearB] = B.split("/").map(Number);
                A = new Date(yearA, monthA - 1, dayA);
                B = new Date(yearB, monthB - 1, dayB);
            }

            return isAsc ? (A > B ? 1 : -1) : (A < B ? 1 : -1);
        });

        // R√©insertion des lignes tri√©es
        rows.forEach(r => tbody.appendChild(r));
    });
});

// Recherche
document.getElementById("search").addEventListener("keyup", function() {
    const filter = this.value.toLowerCase();
    const rows = document.querySelectorAll(".dime-table tbody tr");

    rows.forEach(row => {
        const textContent = Array.from(row.children).map(td => td.textContent.toLowerCase()).join(" ");
        row.style.display = textContent.includes(filter) ? "" : "none";
    });
});
</script>
{% endblock %}
